<map version="freeplane 1.8.0">
<!--To view this file, download free mind mapping software Freeplane from http://freeplane.sourceforge.net -->
<node TEXT="linux虚拟化技术" FOLDED="false" ID="ID_1011942892" CREATED="1605620840890" MODIFIED="1605625192896" STYLE="wide_hexagon" UNIFORM_SHAPE="true">
<font SIZE="20" BOLD="true"/>
<hook NAME="MapStyle" zoom="0.149">
    <properties fit_to_viewport="false" edgeColorConfiguration="#808080ff,#ff0000ff,#0000ffff,#00ff00ff,#ff00ffff,#00ffffff,#7c0000ff,#00007cff,#007c00ff,#7c007cff,#007c7cff,#7c7c00ff"/>

<map_styles>
<stylenode LOCALIZED_TEXT="styles.root_node" STYLE="oval" UNIFORM_SHAPE="true" VGAP_QUANTITY="24.0 pt">
<font SIZE="24"/>
<stylenode LOCALIZED_TEXT="styles.predefined" POSITION="right" STYLE="bubble">
<stylenode LOCALIZED_TEXT="default" ICON_SIZE="12.0 pt" COLOR="#000000" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt" NUMBERED="true" BORDER_WIDTH="2.0 px">
<font NAME="微软雅黑" SIZE="12" BOLD="false" ITALIC="false"/>
<edge STYLE="horizontal"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.details" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="defaultstyle.attributes" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font SIZE="9"/>
</stylenode>
<stylenode LOCALIZED_TEXT="defaultstyle.note" COLOR="#000000" BACKGROUND_COLOR="#ffffff" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt" TEXT_ALIGN="LEFT"/>
<stylenode LOCALIZED_TEXT="defaultstyle.floating">
<edge STYLE="hide_edge"/>
<cloud COLOR="#f0f0f0" SHAPE="ROUND_RECT"/>
</stylenode>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.user-defined" POSITION="right" STYLE="bubble">
<stylenode LOCALIZED_TEXT="styles.topic" COLOR="#18898b" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font NAME="Liberation Sans" SIZE="10" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.subtopic" COLOR="#cc3300" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font NAME="Liberation Sans" SIZE="10" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.subsubtopic" COLOR="#669900" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font NAME="Liberation Sans" SIZE="10" BOLD="true"/>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.important" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<icon BUILTIN="yes"/>
</stylenode>
</stylenode>
<stylenode LOCALIZED_TEXT="styles.AutomaticLayout" POSITION="right" STYLE="bubble">
<stylenode LOCALIZED_TEXT="AutomaticLayout.level.root" COLOR="#000000" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font SIZE="18"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,1" COLOR="#0033ff" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font SIZE="16"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,2" COLOR="#00b439" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font SIZE="14"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,3" COLOR="#990000" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font SIZE="12"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,4" COLOR="#111111" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt">
<font SIZE="10"/>
</stylenode>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,5" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,6" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,7" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,8" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,9" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,10" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
<stylenode LOCALIZED_TEXT="AutomaticLayout.level,11" STYLE="bubble" SHAPE_HORIZONTAL_MARGIN="5.0 pt" SHAPE_VERTICAL_MARGIN="3.0 pt"/>
</stylenode>
</stylenode>
</map_styles>
</hook>
<hook NAME="AutomaticEdgeColor" COUNTER="6" RULE="ON_BRANCH_CREATION"/>
<node TEXT="KVM" POSITION="right" ID="ID_1252698798" CREATED="1605620914373" MODIFIED="1605621202588">
<edge COLOR="#00ff00"/>
<richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      virtualization资源管理
    </p>
    <p>
      x个无理资源--&gt;y个逻辑资源
    </p>
    <p>
      实现程度
    </p>
    <p>
      完全、部分、硬件辅助（现在的虚拟化软件都是硬件辅助虚拟化）
    </p>
  </body>
</html>
</richcontent>
<node TEXT="环境部署" ID="ID_1522161018" CREATED="1605621245265" MODIFIED="1605621250293">
<node TEXT="开启CPU虚拟化功能" ID="ID_1046055917" CREATED="1605621254418" MODIFIED="1605621265213"/>
<node TEXT="安装虚拟化软件" ID="ID_903770310" CREATED="1605621279124" MODIFIED="1606457589870">
<node TEXT="qemu-kvm, 为kvm提供底层仿真支持&#xa;libvirt-daemon, libvirtd守护进程,管理虚拟机&#xa;libvirt-client, 用户端软件,提供客户端管理命令&#xa;libvirt-daemon-driver-qemu, libvirtd连接qemu的驱动&#xa;virt-manager, 图形化的虚拟机管理工具（非必须）" ID="ID_1215771316" CREATED="1606457577791" MODIFIED="1606457586001"/>
</node>
</node>
<node TEXT="管理工具" ID="ID_488215659" CREATED="1605621409710" MODIFIED="1605621432847">
<node TEXT="virt-manager" ID="ID_1308362839" CREATED="1605621434115" MODIFIED="1605621635428"><richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      基本的图形管理工具,实现虚拟机软件般的管理功能,比如创建虚拟机,调节虚拟机配置,以图形界面运行虚拟机,生成快照等类似vmware,只是提供kvm部分功能而非全部
    </p>
  </body>
</html>
</richcontent>
</node>
<node TEXT="virsh" ID="ID_1874929901" CREATED="1605621638218" MODIFIED="1605621739605"><richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      以命令管理虚拟机,提供各虚拟机的命令接口,支持交互模式,查看/创建/停止/关闭等功能
    </p>
    <p>
      格式:virsh 控制指令 虚拟机名称 参数
    </p>
  </body>
</html>
</richcontent>
<node TEXT="查看虚拟机服务器信息&#xa;virsh nodeinfo" ID="ID_204199064" CREATED="1605621746968" MODIFIED="1606457753676"/>
<node TEXT="列出虚拟机,加--all后列出所有&#xa;virsh list [--all]" ID="ID_366209429" CREATED="1605621782913" MODIFIED="1606458373511"/>
<node TEXT="查看指定虚拟机信息&#xa;virsh dominfo 虚拟机名称" ID="ID_1497265523" CREATED="1605621823380" MODIFIED="1606458416122"/>
<node TEXT="运行|重启|关闭指定的虚拟机&#xa;virsh start|reboot|shutdown 虚拟机名称" ID="ID_829490901" CREATED="1605621879233" MODIFIED="1606458463391"/>
<node TEXT="强制关闭指定虚拟机&#xa;virsh destroy 虚拟机名称" ID="ID_1235198798" CREATED="1605621965377" MODIFIED="1606458492601"/>
<node TEXT="开机运行指定虚拟机&#xa;--disable,取消开机启动&#xa;virsh autostart [--disable] 虚拟机名称" ID="ID_1847099857" CREATED="1605622020018" MODIFIED="1606458539861"/>
<node TEXT="取消虚拟机定义域&#xa;virsh undefine 虚拟机名称" ID="ID_379140980" CREATED="1605623155148" MODIFIED="1606458743381"><richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      从列表中删除指定虚拟机
    </p>
    <p>
      要彻底删除虚拟机,只需把磁盘镜像文件和配置文件删除
    </p>
  </body>
</html>

</richcontent>
</node>
</node>
</node>
<node TEXT="手动克隆虚拟机" ID="ID_272144307" CREATED="1605622387214" MODIFIED="1605622404152">
<node TEXT="拷贝虚拟机镜像文件" ID="ID_1397838324" CREATED="1606460140706" MODIFIED="1606460162112">
<node TEXT="/var/lib/libvirt/images/*qcow2&#xa;磁盘镜像文件,保存虚拟机的操作系统及文档数据,镜像路径取决于xml配置文件中的定义&#xa;虚拟机镜像文件格式特点:&#xa;RAW:I/O效率高,占用空间大,不支持压缩,不支持后端盘复用,不支持快照&#xa;QCOW2:I/O效率较高,占用空间小,支持压缩,支持后端盘复用,支持快" ID="ID_191675027" CREATED="1605622407530" MODIFIED="1606460191950"/>
</node>
<node TEXT="建立新的xml配置文件" ID="ID_1882565155" CREATED="1606460229549" MODIFIED="1606460242628">
<node TEXT="/etc/libvirt/qemu/*xml&#xa;配置文件以xml语法格式书写,可配置虚拟机名称、UUID、CPU、内存、虚拟磁盘、网卡等各种参数设置&#xa;可将源镜像的配置文件拷贝一份进行修改,修改基本的四项内容即可:&#xa;虚拟机名称:&lt;name&gt;新虚拟机名&lt;/name&gt;&#xa;虚拟机UUID:&lt;uuid&gt;...&lt;/uuid&gt;导入配置时kvm会自动生成uuid因此只需将这行删除就行了,与源镜像uuid相同会造成导入时定义域错误&#xa;指定磁盘镜像文件:&lt;source file=&apos;路径.qcow2&apos;/&gt;,若修改错误开机是会出现启动域错误&#xa;网卡MAC地址:&lt;mac &apos;...&apos;/&gt;导入配置时kvm会自动生成新的mac地址因此只需删除就行,这步是为了防址与原虚拟机集成时网罗冲突" ID="ID_1869536400" CREATED="1605622482130" MODIFIED="1606460252057"/>
</node>
<node TEXT="导入配置文件" ID="ID_192889379" CREATED="1606460309734" MODIFIED="1606460321238">
<node TEXT="virsh define /etc/libvirt/qemu/新配置文件.xml" ID="ID_1679372799" CREATED="1605622920101" MODIFIED="1606460327304"/>
</node>
<node TEXT="三合一命令" ID="ID_1388606900" CREATED="1606460345683" MODIFIED="1606460380554">
<node TEXT="virsh edit 源虚拟机名称&#xa;综合复制、修改、导入步骤创建新虚拟机配置的命令,会直接调用源虚拟机的配置和vim编辑器,修改成克隆虚拟机的配置保存退出后自动导入,并使新虚拟机可运行" ID="ID_900571483" CREATED="1605624542485" MODIFIED="1606460098949"/>
</node>
</node>
</node>
<node TEXT="写时复制/COW技术" POSITION="right" ID="ID_16072832" CREATED="1605621050106" MODIFIED="1605624515702">
<edge COLOR="#ff00ff"/>
<richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      特点:
    </p>
    <p>
      直接影射原始盘（后端盘）数据内容
    </p>
    <p>
      原始盘（后端盘）内容不变,并且不能修改原始盘内容,否则所有前端盘无法使用
    </p>
    <p>
      对前端盘的修改不回写到原始盘（后端盘）
    </p>
    <p>
      前端盘至少与后端盘一样大小,可以前端盘比后端盘大,不可以前端盘比后端盘小
    </p>
    <p>
      优势:
    </p>
    <p>
      一个后端盘可以影射出无数前端盘,前端盘在未写入新数据时不占用任何空间（因此只需在设置参数上大于或等于后端盘就行）,前端盘不管怎么修改不会影响到后端盘,一个后端盘就能影射出无数虚拟机,大大节省克隆虚拟机的时间和占用空间,新虚拟机占用磁盘仅数百KB
    </p>
  </body>
</html>
</richcontent>
<node TEXT="qemu-img 通过-b选项复用指定后端盘" ID="ID_1739912794" CREATED="1605624056102" MODIFIED="1605624096100"/>
<node TEXT="通过后端盘建立新的前端盘&#xa;qemu-img create -f qcow2 -b 后端盘 前端盘" ID="ID_745886185" CREATED="1605624097572" MODIFIED="1606460616768"/>
<node TEXT="查看前端盘信息&#xa;qemu-img insfo 前端盘名称" ID="ID_1131357742" CREATED="1605624392776" MODIFIED="1606460634956"/>
</node>
<node TEXT="离线访问虚拟机磁盘镜象文件" POSITION="right" ID="ID_733305741" CREATED="1605624724202" MODIFIED="1605625081860">
<edge COLOR="#00ffff"/>
<node TEXT="安装libguestfs-tools-c包" ID="ID_1605267214" CREATED="1605624740712" MODIFIED="1605624919997"><richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      支持离线挂载raw,qcow2格式虚拟磁盘
    </p>
    <p>
      可以在虚拟机关机的情况下直接修改磁盘中的文档
    </p>
    <p>
      方便对虚拟机定制、修复、脚本维护
    </p>
    <p>
      但需要注意SELinux机制的影响,需先把SELinux设为宽松模式,或禁用模式
    </p>
  </body>
</html>
</richcontent>
</node>
<node TEXT="guestmount -a 虚拟磁盘镜像文件 -i 挂载点" ID="ID_420799623" CREATED="1605624952544" MODIFIED="1605625040992"><richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      挂载磁盘镜像文件的命令,挂载后直接访问挂载点就可以对镜像做修改定制了
    </p>
  </body>
</html>
</richcontent>
</node>
</node>
<node TEXT="VDO/虚拟数据优化器" POSITION="right" ID="ID_1588467687" CREATED="1605626127616" MODIFIED="1605626452658">
<edge COLOR="#7c0000"/>
<richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      virtual data optimizer
    </p>
    <p>
      一个内核模块,目的是通过重删减少磁盘的空间占用,以及减少复制带宽
    </p>
    <p>
      VDO是基于块设备层之上的,也就是在原设备之上影射出mapper虚拟设备,然后直接使用即可,表现为1G容量装1.5G数据
    </p>
    <p>
      特点:
    </p>
    <p>
      重复数据删除,输入的数据先判断是否为冗余数据,判断为重复的部分不会写入,然后对源数据进行更新,直接指向原始已经存储的数据块即可
    </p>
    <p>
      压缩,对每个单独的数据块进行处理
    </p>
  </body>
</html>
</richcontent>
<node TEXT="安装所需软件" ID="ID_1439246452" CREATED="1605626623531" MODIFIED="1606460720385">
<node TEXT="yum -y install vdo kmod-kvdo" ID="ID_1192321990" CREATED="1606460696602" MODIFIED="1606460716350"/>
</node>
<node TEXT="制作VDO卷" ID="ID_963885350" CREATED="1605626658776" MODIFIED="1605627112970"><richcontent TYPE="DETAILS">

<html>
  <head>
    
  </head>
  <body>
    <p>
      参考man vdo全文查找/example
    </p>
    <p>
      制作VDO需要2G以上的内存
    </p>
  </body>
</html>
</richcontent>
<node TEXT="创建vdo卷" ID="ID_209841473" CREATED="1606460773770" MODIFIED="1606460784717">
<node TEXT="vdo create --name=VDO卷名称 --device=设备路径 --vdoLogicalSize=逻辑大小" ID="ID_1615747980" CREATED="1605626701811" MODIFIED="1605626764005"/>
</node>
<node TEXT="VDO卷格式化加速（跳过去重分析）" ID="ID_27004713" CREATED="1605626985026" MODIFIED="1606460759344">
<node TEXT="mkfs.xfs -K /dev/mapper/VDO卷名称&#xa;mkfs.ext4 -E nodiscard /dev/mapper/VDO卷名称" ID="ID_1278371827" CREATED="1606460750609" MODIFIED="1606460755905"/>
</node>
<node TEXT="实例" ID="ID_72495025" CREATED="1605627116817" MODIFIED="1606460816575">
<node TEXT="# vdo create --name=vdo0 --device=dev/sdc --vdoLogicalSize=200G&#xa;# mkfs.xfs -K /dev/mapper/vdo0&#xa;# mkdir /nsd01&#xa;# mount /dev/mapper/vd0 /nsd01&#xa;查看挂载信息&#xa;df -h&#xa;查看vdo设备详细信息&#xa;vdostats --hum /dev/mapper/vdo0&#xa;实现开机自动挂载/etc/fstab新增一行&#xa;/dev/mapper/vdo0 /nsd01 xfs deafaults,_netdev 0 0" ID="ID_151648008" CREATED="1606460807809" MODIFIED="1606460813439"/>
</node>
</node>
<node TEXT="管理命令" ID="ID_1365634030" CREATED="1606461008627" MODIFIED="1606461019968">
<node TEXT="列出vdo卷信息&#xa;vdo list" ID="ID_175514948" CREATED="1605626785745" MODIFIED="1606460976870"/>
<node TEXT="查看指定VDO卷状态&#xa;vdo status -n VDO卷名称" ID="ID_1045336427" CREATED="1605626826713" MODIFIED="1606460979581"/>
<node TEXT="删除VDO卷&#xa;vdo remove -n VDO卷名称" ID="ID_1469223828" CREATED="1605626874641" MODIFIED="1606460981415"/>
<node TEXT="查看VDO卷,配以可读性单位&#xa;vdostatus [--human-readable] [/dev/mapper/VDO卷名称]" ID="ID_326934189" CREATED="1605626908577" MODIFIED="1606460983865"/>
</node>
</node>
</node>
</map>
